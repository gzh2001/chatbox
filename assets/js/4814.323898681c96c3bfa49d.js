"use strict";(self.webpackChunkxyz_chatboxapp_ce=self.webpackChunkxyz_chatboxapp_ce||[]).push([[4814],{14814:(e,t,s)=>{s.r(t),s.d(t,{component:()=>de});var o=s(74848),n=s(5482),l=s(40054),i=s(17826),a=s(69019),r=s(64999),d=s(89652),c=s(5055),u=s(30132),m=s(75769),h=s(16267),p=s(1573),g=s(42449),x=s(57693),f=s(83673),b=s.n(f),j=s(35970),v=s.n(j),y=s(96540),w=s(34195),k=s(64721),C=s(42624),M=s(70266),z=s(18871),A=s(23342),B=s(36920),E=s(12335),F=s(11507),S=s(71398),P=s(20916),I=s(27485),$=s(41670),U=s(48324),D=s(24952),K=s(19007),L=s(36912),N=s(29504),W=s(44067),Y=s(11922),R=s(74192),_=s(20899),q=s(1730),T=s(28775),V=s(44986),O=s(51344),G=s(4225),H=s(77439);var Q=s(43073);const J=({chunk:e})=>{const{t}=(0,w.Bd)();return(0,o.jsx)(h.t,{withBorder:!0,p:"md",children:(0,o.jsxs)(a.B,{gap:"xs",children:[(0,o.jsxs)(r.Y,{justify:"space-between",children:[(0,o.jsxs)(i.E,{fw:500,size:"sm",children:[t("Chunk")," ",e.chunkIndex]}),(0,o.jsxs)(i.E,{size:"xs",c:"dimmed",children:[e.text.length," ",t("characters")]})]}),(0,o.jsx)(Q.C,{block:!0,style:{whiteSpace:"pre-wrap",fontSize:"12px",maxHeight:"150px",overflow:"auto"},children:e.text.length>300?`${e.text.substring(0,300)}...`:e.text})]})})},X=({opened:e,onClose:t,file:s,knowledgeBaseId:n,maxChunks:l=5})=>{const{t:d}=(0,w.Bd)(),[c,u]=(0,y.useState)([]),[h,p]=(0,y.useState)(!1),g=y.useMemo((()=>B.A.getKnowledgeBaseController()),[]);return(0,y.useEffect)((()=>{if(!e||!s||!n)return void u([]);(async()=>{p(!0),u([]);try{const e=Array.from({length:Math.min(l,s.chunk_count||0)},((e,t)=>({fileId:s.id,chunkIndex:t}))),t=await g.readFileChunks(n,e);u(t)}catch(e){console.error("Failed to load chunks preview:",e)}finally{p(!1)}})()}),[e,s,n,l,g]),(0,o.jsx)(m.a,{opened:e,onClose:t,title:d("File Chunks Preview"),size:"lg",centered:!0,children:s&&(0,o.jsxs)(a.B,{gap:"md",children:[(0,o.jsxs)(r.Y,{gap:"xs",children:[(0,o.jsx)(i.E,{fw:500,children:s.filename}),(0,o.jsxs)(i.E,{size:"sm",c:"dimmed",children:["(",d("Showing first {{count}} chunks",{count:l}),")"]})]}),h?(0,o.jsx)($.o,{py:"xl",children:(0,o.jsxs)(r.Y,{gap:"xs",children:[(0,o.jsx)(D.a,{size:"sm"}),(0,o.jsx)(i.E,{size:"sm",c:"dimmed",children:d("Loading chunks...")})]})}):c.length>0?(0,o.jsx)(P.F,{h:400,children:(0,o.jsx)(a.B,{gap:"sm",children:c.map((e=>(0,o.jsx)(J,{chunk:e},`${e.fileId}-${e.chunkIndex}`)))})}):(0,o.jsx)($.o,{py:"xl",children:(0,o.jsx)(i.E,{size:"sm",c:"dimmed",children:d("No chunks available. Try converting the file to a text format before adding it to the knowledge base.")})})]})})},Z=({knowledgeBase:e})=>{const{t}=(0,w.Bd)(),[s,l]=y.useState(!1),[d,u]=y.useState(!0),[m,p]=y.useState(!1),[x,f]=y.useState(!1),b=y.useRef(null),j=(()=>{const[e,t]=(0,y.useState)(!1),[s,o]=(0,y.useState)(null);return{isOpen:e,selectedFile:s,openPreview:e=>{o(e),t(!0)},closePreview:()=>{t(!1),o(null)}}})(),{data:v,fetchNextPage:C,isFetchingNextPage:M,isLoading:z,refetch:A}=(0,H.gV)(e?.id||null),{data:Q=0,refetch:J}=(0,H.hj)(e?.id||null),{invalidateFiles:Z}=(0,H.Pe)(),ee=y.useMemo((()=>v?.pages.flatMap((e=>e.files))||[]),[v]);y.useEffect((()=>{if(!e?.id||0===ee.length)return;if(!ee.some((e=>"pending"===e.status||"processing"===e.status||"paused"===e.status)))return;const t=setInterval((()=>{A(),J()}),2e3);return()=>clearInterval(t)}),[e?.id,ee,A,J]);const te=y.useCallback((e=>{const t=e.name.toLowerCase();let s=e.type;return s&&""!==s||(s=t.endsWith(".md")||t.endsWith(".markdown")?"text/markdown":t.endsWith(".txt")?"text/plain":t.endsWith(".pdf")?"application/pdf":t.endsWith(".doc")?"application/msword":t.endsWith(".docx")?"application/vnd.openxmlformats-officedocument.wordprocessingml.document":t.endsWith(".rtf")?"application/rtf":t.endsWith(".csv")?"text/csv":t.endsWith(".epub")?"application/epub+zip":t.endsWith(".jpg")||t.endsWith(".jpeg")?"image/jpeg":t.endsWith(".png")?"image/png":t.endsWith(".gif")?"image/gif":t.endsWith(".webp")?"image/webp":t.endsWith(".bmp")?"image/bmp":"text/plain",console.log(`[Upload] Corrected MIME type for ${e.name}: "${e.type}" -> "${s}"`)),{name:e.name,path:e.path,type:s,size:e.size}}),[]),se=y.useCallback((e=>{u(!0)}),[]),oe=y.useCallback((()=>{u(!1),C()}),[C]);y.useEffect((()=>{u(ee.length>5)}),[ee.length]);const ne=y.useCallback((()=>{const t=[".pdf",".doc",".docx",".txt",".md",".rtf",".ppt",".pptx",".xls",".xlsx",".csv",".epub"],s=[".jpg",".jpeg",".png",".gif",".webp",".bmp"],o=e?.visionModel&&""!==e.visionModel.trim();return{accept:[...[...t,"application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","text/plain","text/markdown","application/rtf","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/csv","application/epub+zip"],...o?[...s,"image/jpeg","image/png","image/gif","image/webp","image/bmp"]:[]].join(","),display:o?[...t,...s]:t}}),[e?.visionModel]),le=y.useCallback((async o=>{if(e?.id&&o.length){console.log(`[Upload] Starting upload for ${o.length} files.`);try{const n=B.A.getKnowledgeBaseController(),i=[];for(let e=0;e<o.length;e++){const t=o[e],s=te(t);i.push(s),console.log(`[Upload] File ${e+1}/${o.length}: ${t.name} (${s.type})`)}const a=await Promise.allSettled(i.map((async t=>(console.log(`[Upload] Starting upload for file: ${t.name}`),await n.uploadFile(e.id,t),t)))),r=a.filter((e=>"fulfilled"===e.status)),d=a.filter((e=>"rejected"===e.status));d.forEach(((e,s)=>{if("rejected"===e.status){const s=i[a.indexOf(e)]?.name||"Unknown file";console.error(`[Upload] Failed to upload file ${s}:`,e.reason),k.oR.error(t("Failed to upload {{filename}}: {{error}}",{filename:s,error:e.reason?.message||"Unknown error"}))}})),r.length>0&&0===d.length?(console.log("[Upload] All files uploaded successfully."),k.oR.success(t("Successfully uploaded {{count}} file(s)",{count:r.length}))):r.length>0&&d.length>0?(console.log(`[Upload] Partial success: ${r.length} succeeded, ${d.length} failed.`),k.oR.success(t("Successfully uploaded {{success}} of {{total}} file(s). {{failed}} file(s) failed.",{success:r.length,total:o.length,failed:d.length}))):d.length===o.length&&console.log("[Upload] All files failed to upload."),r.length>0&&(await Promise.all([A(),J()]),Z(e.id),s||l(!0))}catch(e){console.error("[Upload] Upload operation failed:",e),k.oR.error(t("Upload failed: {{error}}",{error:e?.message||"Unknown error"}))}}}),[e?.id,e?.name,te,A,J,Z,s,t]),ie=y.useCallback((e=>{const t=ne(),s=e.name.toLowerCase(),o=e.type.toLowerCase(),n=t.accept.toLowerCase().split(","),l=n.some((e=>!!e.startsWith(".")&&s.endsWith(e))),i=n.some((e=>!!e.includes("/")&&o===e.trim()));return l||i}),[ne]),ae=y.useCallback((e=>{e.preventDefault(),e.stopPropagation(),p(!0)}),[]),re=y.useCallback((e=>{e.preventDefault(),e.stopPropagation(),e.currentTarget.contains(e.relatedTarget)||p(!1)}),[]),de=y.useCallback((async e=>{e.preventDefault(),e.stopPropagation(),p(!1);const s=e.dataTransfer.files;if(0===s.length)return void k.oR.warning(t("No files were dropped"));const o=[],n=[];for(let e=0;e<s.length;e++){const t=s[e];ie(t)?o.push(t):n.push(t)}if(n.length>0){const e=n.map((e=>e.name)).join(", "),s=ne();k.oR.error(t("{{count}} file(s) not supported: {{files}}. Supported formats: {{formats}}",{count:n.length,files:e,formats:s.display.join(", ")}))}if(o.length>0){console.log(`[Upload] Drag & Drop: ${o.length} valid files out of ${s.length} total`);const e=Object.assign(o,{item:e=>o[e]||null});await le(e)}}),[le,ie,ne,t]),ce=y.useCallback((async t=>{try{const s=B.A.getKnowledgeBaseController();await s.deleteFile(t),e?.id&&Z(e.id)}catch(e){console.error("Failed to delete file:",e)}}),[e?.id,Z]),ue=y.useCallback((async t=>{try{const s=B.A.getKnowledgeBaseController();await s.retryFile(t),e?.id&&(A(),J(),Z(e.id))}catch(e){console.error("Failed to retry file:",e)}}),[e?.id,A,J,Z]),me=y.useCallback((async t=>{try{const s=B.A.getKnowledgeBaseController();await s.pauseFile(t),e?.id&&(A(),J(),Z(e.id))}catch(e){console.error("Failed to pause file:",e)}}),[e?.id,A,J,Z]),he=y.useCallback((async t=>{try{const s=B.A.getKnowledgeBaseController();await s.resumeFile(t),e?.id&&(A(),J(),Z(e.id))}catch(e){console.error("Failed to resume file:",e)}}),[e?.id,A,J,Z]),pe=e=>{if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return`${parseFloat((e/1024**t).toFixed(1))} ${["B","KB","MB","GB"][t]}`},ge=e=>{try{if(!e||Number.isNaN(e))return"Unknown date";const t=new Date(e);if(Number.isNaN(t.getTime()))return"Invalid date";const s=new Date,o=t.toDateString()===s.toDateString(),n=t.getFullYear()===s.getFullYear();return o?t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}):n?t.toLocaleDateString([],{month:"2-digit",day:"2-digit"})+" "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}):t.toLocaleDateString([],{year:"2-digit",month:"2-digit",day:"2-digit"})+" "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1})}catch(t){return console.error("Error formatting date:",e,t),"Invalid date"}},xe=(e,s)=>{switch(e){case"completed":case"done":return(0,o.jsx)(K.A,{size:16,color:"var(--mantine-color-green-6)"});case"processing":return(0,o.jsx)(L.A,{size:16,color:"var(--mantine-color-yellow-6)",style:{animation:"spin 1s linear infinite"}});case"pending":return(0,o.jsx)(L.A,{size:16,color:"var(--mantine-color-gray-6)"});case"paused":return(0,o.jsx)(N.A,{size:16,color:"var(--mantine-color-orange-6)"});case"failed":return(0,o.jsx)(E.m,{label:s||t("Processing failed"),multiline:!0,w:300,withArrow:!0,position:"top",transitionProps:{duration:200},children:(0,o.jsx)(W.A,{size:16,color:"var(--mantine-color-red-6)",style:{cursor:"help"}})});default:return null}},fe=(e,t)=>0===t?0:Math.round(e/t*100),be=y.useCallback((async()=>{e?.id&&(f(!x),x||l(!0))}),[e?.id,x]),je=y.useCallback((async()=>{if(e?.id)try{const e=document.createElement("input");e.type="file",e.multiple=!0;const{accept:t}=ne();e.accept=t,console.log("[Upload] File dialog accept types:",t),e.onchange=async e=>{const t=e.target.files;t&&t.length&&(console.log("[Upload] Files selected:",t.length),await le(t))},setTimeout((()=>{e.click()}),10)}catch(e){console.error("Failed to upload file:",e),k.oR.error(t("Failed to open file dialog: {{error}}",{error:e?.message||"Unknown error"}))}}),[e?.id,ne,le,t]),ve=ne();return(0,o.jsxs)(a.B,{children:[(0,o.jsx)("style",{children:"\n          @keyframes spin {\n            from { transform: rotate(0deg); }\n            to { transform: rotate(360deg); }\n          }\n        "}),(0,o.jsx)(F.a,{children:(0,o.jsxs)(h.t,{withBorder:!0,radius:"sm",p:0,children:[(0,o.jsxs)(r.Y,{align:"center",justify:"space-between",px:"sm",py:"2px",style:{cursor:"pointer",backgroundColor:"var(--mantine-color-chatbox-background-secondary-text)",borderBottom:"1px solid var(--mantine-color-chatbox-border-secondary-light)"},onClick:()=>l(!s),children:[(0,o.jsxs)(r.Y,{children:[s?(0,o.jsx)(Y.A,{size:16,color:"var(--mantine-color-gray-6)"}):(0,o.jsx)(R.A,{size:16,color:"var(--mantine-color-gray-6)"}),(0,o.jsx)(i.E,{size:"sm",fw:600,className:"text-[var(--mantine-color-chatbox-primary-text)]",children:t("Documents")}),(0,o.jsx)(n.a,{size:"xs",bg:Q>0?"var(--mantine-color-chatbox-brand-light)":"var(--mantine-color-gray-2)",c:Q>0?"var(--mantine-color-chatbox-brand-filled)":"var(--mantine-color-gray-6)",fz:"xs",children:Q})]}),(0,o.jsx)(c.$,{variant:"subtle",color:"var(--mantine-color-chatbox-primary-text)",size:"xs",fw:600,leftSection:x?(0,o.jsx)(_.A,{size:14}):(0,o.jsx)(g.A,{size:14}),onClick:e=>{e.stopPropagation(),be()},children:t(x?"Done":"Add File")})]}),(0,o.jsxs)(S.S,{in:s,children:[x&&(0,o.jsx)(F.a,{p:"md",style:{borderBottom:ee.length>0?"1px solid var(--mantine-color-chatbox-gray)":"none"},onDragOver:ae,onDragLeave:re,onDrop:de,children:(0,o.jsx)(h.t,{withBorder:!0,p:"lg",radius:"md",style:{border:m?"2px dashed var(--mantine-color-blue-4)":"2px dashed var(--mantine-color-gray-3)",backgroundColor:m?"var(--mantine-color-blue-0)":"var(--mantine-color-chatbox-gray)",transition:"all 0.2s ease",cursor:"pointer"},onClick:je,children:(0,o.jsxs)(a.B,{align:"center",gap:"sm",children:[(0,o.jsx)(q.A,{size:32,color:m?"var(--mantine-color-blue-6)":"var(--mantine-color-gray-6)"}),(0,o.jsx)(i.E,{size:"sm",fw:500,ta:"center",c:m?"blue":"dimmed",children:t(m?"Drop files here":"Drag and drop files here, or click to browse")}),(0,o.jsxs)(i.E,{size:"xs",c:"dimmed",ta:"center",mt:-4,children:[t("Supported formats"),": ",ve.display.join(", ")]})]})})}),ee.length>0&&(0,o.jsxs)(F.a,{style:{position:"relative"},children:[(0,o.jsx)(P.F,{ref:b,h:300,type:"scroll",onScrollPositionChange:se,onBottomReached:oe,children:(0,o.jsxs)(a.B,{gap:0,children:[ee.map(((e,s)=>(0,o.jsx)(F.a,{children:(0,o.jsxs)(r.Y,{px:"md",py:"sm",justify:"space-between",align:"center",style:{minHeight:60,borderBottom:s<ee.length-1?"1px solid var(--paper-border-color)":"none"},children:[(0,o.jsxs)(r.Y,{gap:"sm",align:"center",style:{flex:1},children:[(0,o.jsx)(T.A,{size:20,color:"var(--mantine-color-blue-6)"}),(0,o.jsxs)(F.a,{style:{flex:1},children:[(0,o.jsx)(i.E,{size:"sm",fw:500,lineClamp:1,children:e.filename}),(0,o.jsxs)(r.Y,{gap:"md",mt:2,children:[(0,o.jsx)(i.E,{size:"xs",c:"dimmed",children:ge(e.createdAt)}),(0,o.jsx)(i.E,{size:"xs",c:"dimmed",children:pe(e.file_size)}),"done"===e.status&&(0,o.jsxs)(i.E,{size:"xs",c:"dimmed",style:{cursor:"pointer",textDecoration:"underline"},onClick:t=>{t.stopPropagation(),j.openPreview(e)},children:[e.chunk_count," ",t("chunks")]}),("processing"===e.status||"paused"===e.status)&&e.total_chunks>0&&(0,o.jsxs)(F.a,{style:{flex:1,minWidth:100},children:[(0,o.jsx)(r.Y,{gap:"xs",align:"center",children:(0,o.jsxs)(i.E,{size:"xs",c:"dimmed",style:{cursor:"pointer"},onClick:t=>{t.stopPropagation(),j.openPreview(e)},children:[e.chunk_count,"/",e.total_chunks," ",t("chunks")," (",fe(e.chunk_count,e.total_chunks),"%)"]})}),(0,o.jsx)(I.k,{value:fe(e.chunk_count,e.total_chunks),size:"xs",mt:2,color:"processing"===e.status?"blue":"orange",radius:"sm"})]})]})]})]}),(0,o.jsxs)(r.Y,{gap:"sm",align:"center",children:[(0,o.jsx)($.o,{w:20,h:20,children:xe(e.status,e.error)}),"failed"===e.status&&(0,o.jsx)(U.M,{variant:"subtle",color:"blue",size:"sm",onClick:()=>ue(e.id),title:t("Retry"),children:(0,o.jsx)(V.A,{size:14})}),"processing"===e.status&&(0,o.jsx)(U.M,{variant:"subtle",color:"orange",size:"sm",onClick:()=>me(e.id),title:t("Pause"),children:(0,o.jsx)(N.A,{size:14})}),"paused"===e.status&&(0,o.jsx)(U.M,{variant:"subtle",color:"green",size:"sm",onClick:()=>he(e.id),title:t("Resume"),children:(0,o.jsx)(O.A,{size:14})}),(0,o.jsx)(U.M,{variant:"subtle",color:"red",size:"sm",onClick:()=>ce(e.id),disabled:"processing"===e.status,title:t("Delete"),children:(0,o.jsx)(G.A,{size:14})})]})]})},e.id))),M&&(0,o.jsx)($.o,{p:"md",children:(0,o.jsx)(D.a,{size:"sm"})})]})}),d&&(0,o.jsx)(F.a,{style:{position:"absolute",bottom:0,left:0,right:0,height:30,background:"linear-gradient(transparent, var(--mantine-color-body))",pointerEvents:"none",zIndex:1}})]}),z&&(0,o.jsx)($.o,{p:"xl",children:(0,o.jsx)(D.a,{size:"lg"})}),!z&&0===ee.length&&(0,o.jsx)(F.a,{p:"xl",children:(0,o.jsxs)(a.B,{align:"center",gap:"sm",children:[(0,o.jsx)(T.A,{size:48,color:"var(--mantine-color-gray-4)"}),(0,o.jsx)(i.E,{size:"sm",c:"dimmed",ta:"center",children:t("No documents yet")}),(0,o.jsx)(i.E,{size:"xs",c:"dimmed",ta:"center",children:t("Upload your first document to get started")})]})})]})]})}),(0,o.jsx)(X,{opened:j.isOpen,onClose:j.closePreview,file:j.selectedFile,knowledgeBaseId:e?.id})]})};var ee=s(46540),te=s(31804),se=s(46214);const oe=({embeddingModelList:e,rerankModelList:t,visionModelList:s,embeddingModel:n,rerankModel:l,visionModel:i,onEmbeddingModelChange:a,onRerankModelChange:r,onVisionModelChange:d,isEmbeddingDisabled:c=!1,showEmbeddingModel:u=!0})=>{const{t:m}=(0,w.Bd)();return(0,o.jsxs)(o.Fragment,{children:[u&&(0,o.jsx)(ee.l,{label:m("Embedding Model"),description:m("Used to extract text feature vectors, add in Settings - Provider - Model List"),data:e,value:n,onChange:a,required:!c,disabled:c,searchable:!0,comboboxProps:{withinPortal:!1},allowDeselect:!1}),(0,o.jsx)(ee.l,{label:m("Rerank Model (optional)"),description:m("Used to get more accurate search results"),data:t,value:l,onChange:r,clearable:!0,searchable:!0,comboboxProps:{withinPortal:!1,position:"bottom"}}),(0,o.jsx)(ee.l,{label:m("Vision Model (optional)"),description:m("Used to preprocess image files, requires models with vision capabilities enabled"),data:s,value:i,onChange:d,clearable:!0,searchable:!0,comboboxProps:{withinPortal:!1,position:"bottom"}})]})},ne=({showModelsLabel:e=!1,hasError:t=!1})=>{const{t:s}=(0,w.Bd)();return(0,o.jsxs)(a.B,{gap:"sm",children:[e&&(0,o.jsxs)(r.Y,{children:[s("Models"),": ",(0,o.jsx)(n.a,{children:"Chatbox AI"})]}),(0,o.jsx)(i.E,{size:"sm",c:"dimmed",children:s("Chatbox AI provides all the essential model support required for knowledge base processing")}),t&&(0,o.jsx)(i.E,{size:"sm",c:"red",children:s("Failed to load Chatbox AI models configuration")})]})},le=({value:e,onChange:t,isChatboxAIDisabled:s=!1})=>{const{t:n}=(0,w.Bd)();return(0,o.jsx)(te.s.Group,{label:n("Model Provider"),value:e,onChange:e=>t(e),children:(0,o.jsxs)(r.Y,{mt:"xs",children:[(0,o.jsx)(te.s,{value:"chatbox-ai",label:"Chatbox AI",disabled:s}),(0,o.jsx)(te.s,{value:"custom",label:n("Custom")})]})})},ie=({onCancel:e,onConfirm:t,confirmText:s,isConfirmDisabled:n=!1,showDelete:l=!1,onDelete:i})=>{const{t:a}=(0,w.Bd)();return l&&i?(0,o.jsxs)(r.Y,{justify:"space-between",children:[(0,o.jsx)(c.$,{variant:"outline",color:"red",leftSection:(0,o.jsx)(G.A,{size:16}),onClick:i,children:a("Delete")}),(0,o.jsxs)(r.Y,{children:[(0,o.jsx)(c.$,{variant:"default",onClick:e,children:a("Cancel")}),(0,o.jsx)(c.$,{onClick:t,disabled:n,children:s})]})]}):(0,o.jsxs)(r.Y,{justify:"flex-end",children:[(0,o.jsx)(c.$,{variant:"default",onClick:e,children:a("Cancel")}),(0,o.jsx)(c.$,{onClick:t,disabled:n,children:s})]})},ae=({value:e,onChange:t,label:s,placeholder:n,autoFocus:l=!1})=>{const{t:i}=(0,w.Bd)();return(0,o.jsx)(se.p.Wrapper,{label:s,children:(0,o.jsx)(se.p,{value:e,onChange:e=>t(e.target.value),placeholder:n||i("New knowledge base name"),autoFocus:l})})},re=({modelValue:e,formatModelName:t,isProviderAvailable:s,type:a,t:r})=>{const d="embedding"===a,c=!!e,u=(0,y.useMemo)((()=>!c||!s(e)),[c,s,e]),m=d?200:150,h=(0,y.useMemo)((()=>c?t(e):r("None")),[c,e,t,r]);return(0,o.jsx)(n.a,{style:{display:"flex",alignItems:"center"},children:(0,o.jsxs)(l.s,{align:"center",gap:"xs",maw:m,h:"100%",children:[(0,o.jsx)(i.E,{c:c?u?"red":"":"dimmed",size:"xs",title:h,style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1},children:h}),!c||s(e)?null:(0,o.jsx)(p.A,{size:12,color:"red",title:r("Provider unavailable")})]})})},de=()=>{const{t:e}=(0,w.Bd)(),[t,s]=(0,y.useState)([]),[n,l]=(0,y.useState)(""),[p,f]=(0,y.useState)(!1),{settings:j}=(0,z.t0)(),[E,F]=(0,y.useState)(null),[S,P]=(0,y.useState)(null),[I,$]=(0,y.useState)(null),[U,D]=(0,y.useState)(null),[K,L]=(0,y.useState)(null),[N,W]=(0,y.useState)(null),[Y,R]=(0,y.useState)(null),[_,q]=(0,y.useState)(!1),[T,V]=(0,y.useState)(null),O=(0,y.useMemo)((()=>!(!T||!j.licenseKey)),[T,j.licenseKey]),[G,H]=(0,y.useState)("custom");(0,y.useEffect)((()=>{H(O?"chatbox-ai":"custom")}),[O]);const{providers:Q}=(0,M.u)(),J=(0,y.useCallback)((e=>b()(v()(Q.map((t=>t.models?.filter(e).map((e=>({label:`${t.name} | ${e.nickname||e.modelId}`,value:`${t.id}:${e.modelId}`})))))))),[Q]),X=(0,y.useMemo)((()=>J((e=>!!e.type&&"embedding"===e.type))),[J]),ee=(0,y.useMemo)((()=>J((e=>"rerank"===e.type))),[J]),te=(0,y.useMemo)((()=>J((e=>!!e.capabilities?.includes("vision")))),[J]),se=(0,y.useMemo)((()=>B.A.getKnowledgeBaseController()),[]),de=(0,y.useCallback)((e=>{if(C.UI.map((e=>e.id)).includes(e))return C.UI.find((t=>t.id===e))?.name;const t=j.customProviders?.find((t=>t.id===e));return t?t.name:e}),[j.customProviders]),ce=(0,y.useCallback)(((e,t)=>{const s=Q.find((t=>t.id===e));if(s){const e=s.models?.find((e=>e.modelId===t));if(e)return e.nickname||e.modelId}}),[Q]),ue=(0,y.useCallback)((e=>{if(!e)return!1;const[t]=e.split(":");return Q.some((e=>e.id===t))}),[Q]);function me(t){if(!t)return e("Unknown");const[s,o]=t.split(":");return`${de(s)} | ${ce(s,o)||o}`}const he=(0,y.useCallback)((async()=>{if(!_)try{const e=await se.list();e&&s(e)}catch(t){k.oR.error(e("Failed to fetch knowledge base list, Error: {{error}}",{error:t}))}}),[se,_,e]);(0,y.useEffect)((()=>{he()}),[he]),(0,y.useEffect)((()=>{(async()=>{try{const e=await B.A.getPlatform(),t=await B.A.getArch();q("win32"===e&&"arm64"===t)}catch(e){console.error("Failed to check platform compatibility:",e)}})()}),[]),(0,y.useEffect)((()=>{(async()=>{try{const e=await A.LO("knowledge_base_models");e.knowledge_base_models&&V(e.knowledge_base_models)}catch(t){k.oR.error(e("Failed to fetch Chatbox AI models config, Error: {{error}}",{error:t}))}})()}),[e]);return(0,o.jsxs)(a.B,{p:"md",gap:"xl",children:[(0,o.jsxs)(r.Y,{justify:"space-between",align:"center",children:[(0,o.jsx)(d.h,{order:5,children:e("Knowledge Base")}),(0,o.jsx)(c.$,{variant:"outline",onClick:()=>f(!0),disabled:_,children:(0,o.jsxs)(r.Y,{gap:"xs",children:[(0,o.jsx)(g.A,{size:16}),(0,o.jsx)(i.E,{size:"sm",c:"chatbox-brand",fw:400,children:e("Add")})]})})]}),_&&(0,o.jsx)(u.F,{variant:"light",color:"orange",title:e("Platform Not Supported"),icon:(0,o.jsx)(x.A,{size:16}),children:(0,o.jsx)(i.E,{size:"sm",children:e("Knowledge Base functionality is not available on Windows ARM64 due to library compatibility issues. This feature is supported on Windows x64, macOS, and Linux.")})}),(0,o.jsx)(m.a,{opened:p,onClose:()=>f(!1),title:e("Create Knowledge Base"),centered:!0,children:(0,o.jsxs)(a.B,{gap:"md",children:[(0,o.jsx)(ae,{value:n,onChange:l,autoFocus:!0}),(0,o.jsx)(le,{value:G,onChange:H,isChatboxAIDisabled:!O}),"chatbox-ai"===G?(0,o.jsx)(ne,{hasError:!T}):(0,o.jsx)(oe,{embeddingModelList:X,rerankModelList:ee,visionModelList:te,embeddingModel:E,rerankModel:S,visionModel:I,onEmbeddingModelChange:F,onRerankModelChange:P,onVisionModelChange:$}),(0,o.jsx)(ie,{onCancel:()=>f(!1),onConfirm:async()=>{if(!n)return;let t,s,o;if("chatbox-ai"===G){if(!T)return;t=T.embedding,s=T.rerank,o=T.vision}else{if(!E)return;t=E,s=S||"",o=I||""}try{await se.create({name:n,embeddingModel:t,rerankModel:s,visionModel:o}),l(""),H("chatbox-ai"),F(null),P(null),$(null),f(!1),he()}catch(t){k.oR.error(e("Failed to create knowledge base, Error: {{error}}",{error:t}))}},confirmText:e("Create"),isConfirmDisabled:!n||("chatbox-ai"===G?!O:!E)})]})}),(0,o.jsx)(m.a,{opened:!!U,onClose:()=>D(null),title:e("Edit Knowledge Base"),centered:!0,children:(0,o.jsxs)(a.B,{gap:"md",children:[(0,o.jsx)(ae,{value:U?.name||"",onChange:e=>U&&D({...U,name:e}),label:e("Name")}),U?.embeddingModel?.startsWith("chatbox-ai")?(0,o.jsx)(ne,{showModelsLabel:!0}):(0,o.jsx)(oe,{embeddingModelList:X,rerankModelList:ee,visionModelList:te,embeddingModel:U?`${U.embeddingModel}`:"",rerankModel:K,visionModel:N,onRerankModelChange:L,onVisionModelChange:W,isEmbeddingDisabled:!0}),(0,o.jsx)(ie,{onCancel:()=>D(null),onConfirm:async()=>{if(U)try{await se.update({id:U.id,name:U.name,rerankModel:K||"",visionModel:N||""}),D(null),L(null),W(null),he()}catch(t){k.oR.error(e("Failed to update knowledge base, Error: {{error}}",{error:t}))}},confirmText:e("Save"),showDelete:!0,onDelete:()=>R(U)})]})}),(0,o.jsx)(m.a,{opened:!!Y,onClose:()=>R(null),title:e("Delete Knowledge Base"),centered:!0,size:"sm",children:(0,o.jsxs)(a.B,{gap:"md",children:[(0,o.jsxs)(i.E,{size:"sm",children:[e("Are you sure you want to delete the knowledge base"),' "',Y?.name,'"?']}),(0,o.jsx)(i.E,{size:"sm",c:"dimmed",children:e("This action cannot be undone. All documents and their embeddings will be permanently deleted.")}),(0,o.jsxs)(r.Y,{justify:"flex-end",children:[(0,o.jsx)(c.$,{variant:"default",onClick:()=>R(null),children:e("Cancel")}),(0,o.jsx)(c.$,{color:"red",onClick:async()=>{if(Y)try{await se.delete(Y.id),R(null),D(null),he()}catch(e){console.error("Failed to delete knowledge base:",e)}},children:e("Delete")})]})]})}),!_&&(0,o.jsx)(a.B,{gap:"xl",children:0===t.length?(0,o.jsx)(h.t,{withBorder:!0,p:"xl",style:{textAlign:"center"},children:(0,o.jsxs)(a.B,{gap:"md",align:"center",children:[(0,o.jsx)(x.A,{size:48,color:"var(--mantine-color-dimmed)"}),(0,o.jsxs)(a.B,{gap:"xs",align:"center",children:[(0,o.jsx)(i.E,{fw:500,size:"lg",children:e("No Knowledge Base Yet")}),(0,o.jsx)(i.E,{size:"sm",c:"dimmed",style:{maxWidth:400},children:e("Create your first knowledge base to start adding documents and enhance your AI conversations with contextual information.")})]}),(0,o.jsx)(c.$,{variant:"outline",onClick:()=>f(!0),size:"sm",children:(0,o.jsxs)(r.Y,{gap:"xs",children:[(0,o.jsx)(g.A,{size:16}),e("Create First Knowledge Base")]})})]})}):t.map((t=>(0,o.jsx)(h.t,{withBorder:!0,p:"md",children:(0,o.jsxs)(a.B,{gap:"md",children:[(0,o.jsxs)(a.B,{gap:"0",children:[(0,o.jsxs)(r.Y,{justify:"space-between",align:"center",children:[(0,o.jsx)(i.E,{fw:600,size:"lg",children:t.name}),(0,o.jsx)(c.$,{size:"xs",variant:"subtle",onClick:()=>(e=>{D(e),L(e.rerankModel?`${e.rerankModel}`:null),W(e.visionModel?`${e.visionModel}`:null)})(t),children:e("Edit")})]}),(0,o.jsx)(r.Y,{gap:"xs",wrap:"wrap",align:"center",children:t.embeddingModel?.startsWith("chatbox-ai")?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(i.E,{size:"xs",c:"dimmed",children:[e("Models"),":"]}),(0,o.jsx)(re,{modelValue:"Chatbox AI",formatModelName:()=>"Chatbox AI",isProviderAvailable:()=>O,type:"embedding",t:e})]}):(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(i.E,{size:"xs",c:"dimmed",children:[e("Embedding"),":"]}),(0,o.jsx)(re,{modelValue:t.embeddingModel,formatModelName:me,isProviderAvailable:ue,type:"embedding",t:e}),(0,o.jsxs)(i.E,{size:"xs",c:"dimmed",children:[e("Rerank"),":"]}),(0,o.jsx)(re,{modelValue:t.rerankModel,formatModelName:me,isProviderAvailable:ue,type:"rerank",t:e}),(0,o.jsxs)(i.E,{size:"xs",c:"dimmed",children:[e("Vision"),":"]}),(0,o.jsx)(re,{modelValue:t.visionModel,formatModelName:me,isProviderAvailable:ue,type:"vision",t:e})]})})]}),(0,o.jsx)(Z,{knowledgeBase:t})]})},t.id)))})]})}},77439:(e,t,s)=>{s.d(t,{IM:()=>a,Pe:()=>c,gV:()=>d,hj:()=>r});var o=s(36920),n=s(97286),l=s(6475),i=s(97665);const a=()=>(0,n.I)({queryKey:["knowledge-bases"],queryFn:async()=>o.A.getKnowledgeBaseController().list()}),r=e=>(0,n.I)({queryKey:["knowledge-base-files-count",e],queryFn:async()=>{if(!e)return 0;return o.A.getKnowledgeBaseController().countFiles(e)},enabled:!!e}),d=(e,t=20)=>(0,l.q)({queryKey:["knowledge-base-files",e,t],queryFn:async({pageParam:s=0})=>{if(!e)return{files:[],nextCursor:null};const n=o.A.getKnowledgeBaseController(),l=await n.listFilesPaginated(e,s*t,t);return{files:l,nextCursor:l.length===t?s+1:null}},getNextPageParam:e=>e.nextCursor,enabled:!!e,initialPageParam:0}),c=()=>{const e=(0,i.jE)();return{invalidateFiles:t=>{e.invalidateQueries({queryKey:["knowledge-base-files",t]}),e.invalidateQueries({queryKey:["knowledge-base-files-count",t]})}}}},72747:(e,t,s)=>{s.d(t,{A:()=>c});var o=s(97286),n=s(34843),l=s(96540),i=s(24597),a=s(23342),r=s(80316),d=s(18871);const c=()=>{const e=(0,n.md)(r.an),{providerSettings:t,setProviderSettings:s}=(0,d.Go)(i.wU.ChatboxAI),{data:c,...u}=(0,o.I)({queryKey:["chatbox-ai-models",e],queryFn:async()=>{const t=await(0,a.FU)({aiProvider:i.wU.ChatboxAI,language:e});return t.models&&t.models.length>0&&s((e=>({...e,models:t.models.map((e=>({modelId:e.modelId,nickname:e.modelName,labels:e.labels,capabilities:e.capabilities,type:e.type})))}))),t.models}}),m=(0,l.useMemo)((()=>c?.map((e=>({modelId:e.modelId,nickname:e.modelName,labels:e.labels,capabilities:e.capabilities,type:e.type})))||[]),[c]),h=(0,l.useMemo)((()=>m.filter((e=>!t?.excludedModels?.includes(e.modelId)))),[m,t]);return{allChatboxAIModels:m,chatboxAIModels:h,...u}}},70266:(e,t,s)=>{s.d(t,{u:()=>r});var o=s(96540),n=s(42624),l=s(24597),i=s(72747),a=s(18871);const r=()=>{const{chatboxAIModels:e}=(0,i.A)(),{settings:t,setSettings:s}=(0,a.t0)(),r=t.providers,d=(0,o.useMemo)((()=>[...n.UI,...t.customProviders||[]]),[t.customProviders]),c=(0,o.useMemo)((()=>d.map((s=>{const o=r?.[s.id];return s.id===l.wU.ChatboxAI&&t.licenseKey?{...s,...o,models:e}:!s.isCustom&&o?.apiKey||(s.isCustom||s.id===l.wU.Ollama||s.id===l.wU.LMStudio)&&o?.models?.length?{models:s.defaultSettings?.models,...s,...o}:null})).filter((e=>!!e))),[r,d,e,t.licenseKey]),u=(0,o.useMemo)((()=>t.favoritedModels?.map((e=>{const t=c.find((t=>t.id===e.provider)),s=(t?.models||t?.defaultSettings?.models)?.find((t=>t.modelId===e.model));if(t&&s)return{provider:t,model:s}})).filter((e=>!!e))),[t.favoritedModels,c]),m=(0,o.useCallback)(((e,o)=>{s({favoritedModels:[...t.favoritedModels||[],{provider:e,model:o}]})}),[t,s]),h=(0,o.useCallback)(((e,o)=>{s({favoritedModels:(t.favoritedModels||[]).filter((t=>t.provider!==e||t.model!==o))})}),[t,s]),p=(0,o.useCallback)(((e,t)=>!!u?.find((s=>s.provider?.id===e&&s.model?.modelId===t))),[u]);return{providers:c,favoritedModels:u,favoriteModel:m,unfavoriteModel:h,isFavoritedModel:p}}},18871:(e,t,s)=>{s.d(t,{Go:()=>r,lF:()=>d,t0:()=>a});var o=s(34843),n=s(6447),l=s(96540),i=s(80316);const a=()=>{const[e,t]=(0,o.fp)(i.FU);return{settings:e,setSettings:(0,l.useCallback)((e=>{t((t=>{const s="function"==typeof e?e(t):e;return{...t,...s}}))}),[t])}},r=e=>{const{settings:t,setSettings:s}=a(),o=t.providers?.[e];return{providerSettings:o,setProviderSettings:t=>{s((s=>{const o=s.providers?.[e]||{},n="function"==typeof t?t(o):t;return{providers:{...s.providers||{},[e]:{...o,...n}}}}))}}},d=()=>(0,n.d)(i.FU)}}]);